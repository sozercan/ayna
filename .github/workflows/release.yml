name: Release Build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional tag/label used for naming the release asset'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: macos-26
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Run unit tests
      run: |
        set -o pipefail
        xcodebuild \
          -project ayna.xcodeproj \
          -scheme Ayna \
          -destination 'platform=macOS' \
          -derivedDataPath ./build \
          -only-testing:aynaTests \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          test

    - name: Run UI tests (with retry)
      run: |
        set -o pipefail
        # UI tests can be flaky - retry up to 2 times
        for attempt in 1 2; do
          echo "Attempt $attempt of 2"
          if xcodebuild \
            -project ayna.xcodeproj \
            -scheme Ayna \
            -destination 'platform=macOS' \
            -derivedDataPath ./build \
            -only-testing:aynaUITests \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=YES \
            CODE_SIGNING_ALLOWED=YES \
            -retry-tests-on-failure \
            test; then
            echo "Tests passed on attempt $attempt"
            break
          fi
          if [ $attempt -lt 2 ]; then
            echo "Tests failed, retrying..."
            sleep 5
          else
            echo "Tests failed after 2 attempts"
            exit 1
          fi
        done

    - name: Build release configuration
      run: |
        xcodebuild -project ayna.xcodeproj \
          -scheme Ayna \
          -configuration Release \
          -destination 'platform=macOS' \
          -derivedDataPath ./build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          build

    - name: Create DMG
      run: |
        APP_PATH=$(find ./build/Build/Products/Release -name "*.app" -type d | head -n 1)

        if [ -z "$APP_PATH" ]; then
          echo "Error: Could not find built app"
          exit 1
        fi

        echo "Found app at: $APP_PATH"

        mkdir -p dmg_contents
        cp -R "$APP_PATH" dmg_contents/

        hdiutil create -volname "Ayna" \
          -srcfolder dmg_contents \
          -ov -format UDZO \
          ayna.dmg

    - name: Determine artifact name
      id: artifact
      run: |
        if [ -n "${{ inputs.tag }}" ]; then
          TAG="${{ inputs.tag }}"
        elif [ -n "${{ github.ref_name }}" ]; then
          TAG="${{ github.ref_name }}"
        else
          TAG="${GITHUB_SHA::7}"
        fi

        if [ -z "$TAG" ]; then
          TAG="release"
        fi

        echo "tag=$TAG" >> "$GITHUB_OUTPUT"
        echo "filename=ayna-$TAG.dmg" >> "$GITHUB_OUTPUT"

    - name: Rename DMG
      run: mv ayna.dmg "${{ steps.artifact.outputs.filename }}"

    - name: Upload artifact
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v4
      with:
        name: ${{ steps.artifact.outputs.filename }}
        path: ${{ steps.artifact.outputs.filename }}
        retention-days: 30

    - name: Create GitHub release and upload DMG
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -eo pipefail

        TAG="${{ steps.artifact.outputs.tag }}"
        FILE="${{ steps.artifact.outputs.filename }}"
        TITLE="Ayna ${TAG}"
        NOTES="Automated release for ${TAG} (build ${GITHUB_SHA})"

        if gh release view "$TAG" >/dev/null 2>&1; then
          echo "Release $TAG already exists, uploading asset instead"
          gh release upload "$TAG" "$FILE" --clobber
        else
          gh release create "$TAG" "$FILE" \
            --title "$TITLE" \
            --notes "$NOTES"
        fi

    - name: Update Homebrew Cask
      if: success()
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG="${{ steps.artifact.outputs.tag }}"
        FILE="${{ steps.artifact.outputs.filename }}"

        # Strip 'v' prefix from tag for version
        VERSION="${TAG#v}"

        # Calculate SHA256
        SHA256=$(shasum -a 256 "$FILE" | awk '{print $1}')

        echo "Updating Cask to version $VERSION with sha256 $SHA256"

        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Create new branch
        BRANCH_NAME="bump-cask-${VERSION}"
        git checkout -b "$BRANCH_NAME"

        # Update Cask file
        sed -i '' "s/version \".*\"/version \"$VERSION\"/" Casks/ayna.rb
        sed -i '' "s/sha256 \".*\"/sha256 \"$SHA256\"/" Casks/ayna.rb

        # Commit and push
        if ! git diff --quiet Casks/ayna.rb; then
          git add Casks/ayna.rb
          git commit -m "Update Cask to version $VERSION"
          git push origin "$BRANCH_NAME"

          # Create PR
          gh pr create \
            --title "Update Cask to version $VERSION" \
            --body "Automated update of Homebrew Cask for version $VERSION" \
            --base main \
            --head "$BRANCH_NAME"
        fi
