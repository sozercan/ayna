name: Test Suite

on:
  push:
    branches: [ main ]
    paths:
      - '**.swift'
      - '**.xcodeproj/**'
      - '**.xcworkspace/**'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.swift'
      - '**.xcodeproj/**'
      - '**.xcworkspace/**'
      - '.github/workflows/tests.yml'
  workflow_dispatch:

jobs:
  macos_unit_tests:
    name: macOS Unit Tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: macos-14
            xcode-path: /Applications/Xcode_16.2.app/Contents/Developer
          - macos-version: macos-15
            xcode-path: /Applications/Xcode_16.4.app/Contents/Developer
          - macos-version: macos-26
            xcode-path: /Applications/Xcode_26.0.app/Contents/Developer
    runs-on: ${{ matrix.macos-version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

    - name: Select Xcode version
      run: sudo xcode-select -s ${{ matrix.xcode-path }}

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Run unit tests
      run: |
        set -o pipefail
        xcodebuild \
          -project Ayna.xcodeproj \
          -scheme Ayna \
          -destination 'platform=macOS' \
          -derivedDataPath ./build \
          -only-testing:aynaTests \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          test

  macos_ui_tests:
    name: macOS UI Tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: macos-14
            xcode-path: /Applications/Xcode_16.2.app/Contents/Developer
          - macos-version: macos-15
            xcode-path: /Applications/Xcode_16.4.app/Contents/Developer
          - macos-version: macos-26
            xcode-path: /Applications/Xcode_26.0.app/Contents/Developer
    runs-on: ${{ matrix.macos-version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

    - name: Select Xcode version
      run: sudo xcode-select -s ${{ matrix.xcode-path }}

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Run UI tests
      run: |
        set -o pipefail
        xcodebuild \
          -project Ayna.xcodeproj \
          -scheme Ayna \
          -destination 'platform=macOS' \
          -derivedDataPath ./build \
          -only-testing:aynaUITests \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=YES \
          CODE_SIGNING_ALLOWED=YES \
          test

  ios_unit_tests:
    name: iOS Unit Tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: macos-15
            xcode-path: /Applications/Xcode_16.4.app/Contents/Developer
            destination: 'platform=iOS Simulator,name=iPhone 16 Pro Max'
          - macos-version: macos-26
            xcode-path: /Applications/Xcode_26.0.app/Contents/Developer
            destination: 'platform=iOS Simulator,name=iPhone 17'
    runs-on: ${{ matrix.macos-version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

    - name: Select Xcode version
      run: sudo xcode-select -s ${{ matrix.xcode-path }}

    - name: Show Xcode version
      run: xcodebuild -version

    - name: List available simulators
      run: |
        echo "Available iOS runtimes:"
        xcrun simctl list runtimes | grep -i ios || true
        echo "Available iOS devices:"
        xcrun simctl list devices available | grep -i iphone | head -20 || true

    - name: Run iOS unit tests
      run: |
        set -o pipefail
        xcodebuild \
          -project Ayna.xcodeproj \
          -scheme Ayna-iOS \
          -destination '${{ matrix.destination }}' \
          -derivedDataPath ./build \
          -only-testing:Ayna-iOSTests \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          test

  ios_ui_tests:
    name: iOS UI Tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: macos-15
            xcode-path: /Applications/Xcode_16.4.app/Contents/Developer
            destination: 'platform=iOS Simulator,name=iPhone 16 Pro Max'
          - macos-version: macos-26
            xcode-path: /Applications/Xcode_26.0.app/Contents/Developer
            destination: 'platform=iOS Simulator,name=iPhone 17'
    runs-on: ${{ matrix.macos-version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

    - name: Select Xcode version
      run: sudo xcode-select -s ${{ matrix.xcode-path }}

    - name: Show Xcode version
      run: xcodebuild -version

    - name: List available simulators
      run: |
        echo "Available iOS runtimes:"
        xcrun simctl list runtimes | grep -i ios || true
        echo "Available iOS devices:"
        xcrun simctl list devices available | grep -i iphone | head -20 || true

    - name: Run iOS UI tests
      run: |
        set -o pipefail
        xcodebuild \
          -project Ayna.xcodeproj \
          -scheme Ayna-iOS \
          -destination '${{ matrix.destination }}' \
          -derivedDataPath ./build \
          -only-testing:Ayna-iOSUITests \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=YES \
          CODE_SIGNING_ALLOWED=YES \
          test

  watchos_unit_tests:
    name: watchOS Unit Tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: macos-15
            xcode-path: /Applications/Xcode_16.4.app/Contents/Developer
            destination: 'platform=watchOS Simulator,name=Apple Watch Ultra 2 (49mm)'
          - macos-version: macos-26
            xcode-path: /Applications/Xcode_26.0.app/Contents/Developer
            destination: 'platform=watchOS Simulator,name=Apple Watch Ultra 3 (49mm)'
    runs-on: ${{ matrix.macos-version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

    - name: Select Xcode version
      run: sudo xcode-select -s ${{ matrix.xcode-path }}

    - name: Show Xcode version
      run: xcodebuild -version

    - name: List available simulators
      run: |
        echo "Available watchOS runtimes:"
        xcrun simctl list runtimes | grep -i watchos || true
        echo "Available watchOS devices:"
        xcrun simctl list devices available | grep -i watch | head -20 || true

    - name: Run watchOS unit tests
      run: |
        set -o pipefail
        xcodebuild \
          -project Ayna.xcodeproj \
          -scheme 'Ayna-watchOS Watch App' \
          -destination '${{ matrix.destination }}' \
          -derivedDataPath ./build \
          -only-testing:Ayna-watchOSTests \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          test

  watchos_ui_tests:
    name: watchOS UI Tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: macos-15
            xcode-path: /Applications/Xcode_16.4.app/Contents/Developer
            destination: 'platform=watchOS Simulator,name=Apple Watch Ultra 2 (49mm)'
          - macos-version: macos-26
            xcode-path: /Applications/Xcode_26.0.app/Contents/Developer
            destination: 'platform=watchOS Simulator,name=Apple Watch Ultra 3 (49mm)'
    runs-on: ${{ matrix.macos-version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

    - name: Select Xcode version
      run: sudo xcode-select -s ${{ matrix.xcode-path }}

    - name: Show Xcode version
      run: xcodebuild -version

    - name: List available simulators
      run: |
        echo "Available watchOS runtimes:"
        xcrun simctl list runtimes | grep -i watchos || true
        echo "Available watchOS devices:"
        xcrun simctl list devices available | grep -i watch | head -20 || true

    - name: Run watchOS UI tests
      run: |
        set -o pipefail
        xcodebuild \
          -project Ayna.xcodeproj \
          -scheme 'Ayna-watchOS Watch App' \
          -destination '${{ matrix.destination }}' \
          -derivedDataPath ./build \
          -only-testing:Ayna-watchOSUITests \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=YES \
          CODE_SIGNING_ALLOWED=YES \
          test
