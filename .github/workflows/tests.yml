name: Test Suite

on:
  push:
    branches: [ main ]
    paths:
      - '**.swift'
      - '**.xcodeproj/**'
      - '**.xcworkspace/**'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.swift'
      - '**.xcodeproj/**'
      - '**.xcworkspace/**'
      - '.github/workflows/tests.yml'
  workflow_dispatch:

jobs:
  macos_unit_tests:
    name: macOS Unit Tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: macos-14
            xcode-path: /Applications/Xcode_16.2.app/Contents/Developer
          - macos-version: macos-15
            xcode-path: /Applications/Xcode_16.4.app/Contents/Developer
          - macos-version: macos-26
            xcode-path: /Applications/Xcode_26.0.app/Contents/Developer
    runs-on: ${{ matrix.macos-version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

    - name: Select Xcode version
      run: sudo xcode-select -s ${{ matrix.xcode-path }}

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Run unit tests
      run: |
        set -o pipefail
        xcodebuild \
          -project Ayna.xcodeproj \
          -scheme Ayna \
          -destination 'platform=macOS' \
          -derivedDataPath ./build \
          -only-testing:aynaTests \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          test

  macos_ui_tests:
    name: macOS UI Tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: macos-14
            xcode-path: /Applications/Xcode_16.2.app/Contents/Developer
          - macos-version: macos-15
            xcode-path: /Applications/Xcode_16.4.app/Contents/Developer
          - macos-version: macos-26
            xcode-path: /Applications/Xcode_26.0.app/Contents/Developer
    runs-on: ${{ matrix.macos-version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

    - name: Select Xcode version
      run: sudo xcode-select -s ${{ matrix.xcode-path }}

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Run UI tests
      run: |
        set -o pipefail
        xcodebuild \
          -project Ayna.xcodeproj \
          -scheme Ayna \
          -destination 'platform=macOS' \
          -derivedDataPath ./build \
          -only-testing:aynaUITests \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=YES \
          CODE_SIGNING_ALLOWED=YES \
          test

  ios_unit_tests:
    name: iOS Unit Tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: macos-14
            xcode-path: /Applications/Xcode_16.2.app/Contents/Developer
            simulator: iPhone 15
            ios-runtime: iOS-17-5
          - macos-version: macos-15
            xcode-path: /Applications/Xcode_16.4.app/Contents/Developer
            simulator: iPhone 16 Pro Max
            ios-runtime: ''
          - macos-version: macos-26
            xcode-path: /Applications/Xcode_26.0.app/Contents/Developer
            simulator: iPhone 17
            ios-runtime: ''
    runs-on: ${{ matrix.macos-version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v4

    - name: Select Xcode version
      run: sudo xcode-select -s ${{ matrix.xcode-path }}

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Install iOS runtime and create simulator
      if: matrix.ios-runtime != ''
      run: |
        # Install iOS 17.5 runtime for iPhone 15
        xcodebuild -downloadPlatform iOS -buildVersion 21F79
        # List available runtimes and device types for debugging
        echo "Available iOS runtimes:"
        xcrun simctl list runtimes | grep -i ios
        echo "Available iPhone device types:"
        xcrun simctl list devicetypes | grep -i iphone
        # Create iPhone 15 simulator with iOS 17.5
        xcrun simctl create "iPhone 15" "com.apple.CoreSimulator.SimDeviceType.iPhone-15" "com.apple.CoreSimulator.SimRuntime.iOS-17-5" || true
        # Verify simulator was created
        xcrun simctl list devices | grep -i "iphone 15"

    - name: Run iOS unit tests
      run: |
        set -o pipefail
        xcodebuild \
          -project Ayna.xcodeproj \
          -scheme Ayna-iOS \
          -destination 'platform=iOS Simulator,name=${{ matrix.simulator }}' \
          -derivedDataPath ./build \
          -only-testing:Ayna-iOSTests \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          test

  ios_ui_tests:
    name: iOS UI Tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: macos-14
            xcode-path: /Applications/Xcode_16.2.app/Contents/Developer
            simulator: iPhone 15
            ios-runtime: iOS-17-5
          - macos-version: macos-15
            xcode-path: /Applications/Xcode_16.4.app/Contents/Developer
            simulator: iPhone 16 Pro Max
            ios-runtime: ''
          - macos-version: macos-26
            xcode-path: /Applications/Xcode_26.0.app/Contents/Developer
            simulator: iPhone 17
            ios-runtime: ''
    runs-on: ${{ matrix.macos-version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v4

    - name: Select Xcode version
      run: sudo xcode-select -s ${{ matrix.xcode-path }}

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Install iOS runtime and create simulator
      if: matrix.ios-runtime != ''
      run: |
        # Install iOS 17.5 runtime for iPhone 15
        xcodebuild -downloadPlatform iOS -buildVersion 21F79
        # List available runtimes and device types for debugging
        echo "Available iOS runtimes:"
        xcrun simctl list runtimes | grep -i ios
        echo "Available iPhone device types:"
        xcrun simctl list devicetypes | grep -i iphone
        # Create iPhone 15 simulator with iOS 17.5
        xcrun simctl create "iPhone 15" "com.apple.CoreSimulator.SimDeviceType.iPhone-15" "com.apple.CoreSimulator.SimRuntime.iOS-17-5" || true
        # Verify simulator was created
        xcrun simctl list devices | grep -i "iphone 15"

    - name: Run iOS UI tests
      run: |
        set -o pipefail
        xcodebuild \
          -project Ayna.xcodeproj \
          -scheme Ayna-iOS \
          -destination 'platform=iOS Simulator,name=${{ matrix.simulator }}' \
          -derivedDataPath ./build \
          -only-testing:Ayna-iOSUITests \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=YES \
          CODE_SIGNING_ALLOWED=YES \
          test

  watchos_unit_tests:
    name: watchOS Unit Tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: macos-14
            xcode-path: /Applications/Xcode_16.2.app/Contents/Developer
            simulator: Apple Watch Series 9 (45mm)
            watchos-runtime: watchOS-10-5
          - macos-version: macos-15
            xcode-path: /Applications/Xcode_16.4.app/Contents/Developer
            simulator: Apple Watch Ultra 2 (49mm)
            watchos-runtime: ''
          - macos-version: macos-26
            xcode-path: /Applications/Xcode_26.0.app/Contents/Developer
            simulator: Apple Watch Ultra 3 (49mm)
            watchos-runtime: ''
    runs-on: ${{ matrix.macos-version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v4

    - name: Select Xcode version
      run: sudo xcode-select -s ${{ matrix.xcode-path }}

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Install watchOS runtime and create simulator
      if: matrix.watchos-runtime != ''
      run: |
        # Install watchOS 10.5 runtime for Apple Watch Series 9
        xcodebuild -downloadPlatform watchOS -buildVersion 21T576
        # List available runtimes and device types for debugging
        echo "Available watchOS runtimes:"
        xcrun simctl list runtimes | grep -i watchos
        echo "Available Watch device types:"
        xcrun simctl list devicetypes | grep -i watch
        # Create Apple Watch Series 9 simulator with watchOS 10.5
        xcrun simctl create "Apple Watch Series 9 (45mm)" "com.apple.CoreSimulator.SimDeviceType.Apple-Watch-Series-9-45mm" "com.apple.CoreSimulator.SimRuntime.watchOS-10-5" || true
        # Verify simulator was created
        xcrun simctl list devices | grep -i "watch series 9"

    - name: Run watchOS unit tests
      run: |
        set -o pipefail
        xcodebuild \
          -project Ayna.xcodeproj \
          -scheme 'Ayna-watchOS Watch App' \
          -destination 'platform=watchOS Simulator,name=${{ matrix.simulator }}' \
          -derivedDataPath ./build \
          -only-testing:Ayna-watchOSTests \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          test

  watchos_ui_tests:
    name: watchOS UI Tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: macos-14
            xcode-path: /Applications/Xcode_16.2.app/Contents/Developer
            simulator: Apple Watch Series 9 (45mm)
            watchos-runtime: watchOS-10-5
          - macos-version: macos-15
            xcode-path: /Applications/Xcode_16.4.app/Contents/Developer
            simulator: Apple Watch Ultra 2 (49mm)
            watchos-runtime: ''
          - macos-version: macos-26
            xcode-path: /Applications/Xcode_26.0.app/Contents/Developer
            simulator: Apple Watch Ultra 3 (49mm)
            watchos-runtime: ''
    runs-on: ${{ matrix.macos-version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v4

    - name: Select Xcode version
      run: sudo xcode-select -s ${{ matrix.xcode-path }}

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Install watchOS runtime and create simulator
      if: matrix.watchos-runtime != ''
      run: |
        # Install watchOS 10.5 runtime for Apple Watch Series 9
        xcodebuild -downloadPlatform watchOS -buildVersion 21T576
        # List available runtimes and device types for debugging
        echo "Available watchOS runtimes:"
        xcrun simctl list runtimes | grep -i watchos
        echo "Available Watch device types:"
        xcrun simctl list devicetypes | grep -i watch
        # Create Apple Watch Series 9 simulator with watchOS 10.5
        xcrun simctl create "Apple Watch Series 9 (45mm)" "com.apple.CoreSimulator.SimDeviceType.Apple-Watch-Series-9-45mm" "com.apple.CoreSimulator.SimRuntime.watchOS-10-5" || true
        # Verify simulator was created
        xcrun simctl list devices | grep -i "watch series 9"

    - name: Run watchOS UI tests
      run: |
        set -o pipefail
        xcodebuild \
          -project Ayna.xcodeproj \
          -scheme 'Ayna-watchOS Watch App' \
          -destination 'platform=watchOS Simulator,name=${{ matrix.simulator }}' \
          -derivedDataPath ./build \
          -only-testing:Ayna-watchOSUITests \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=YES \
          CODE_SIGNING_ALLOWED=YES \
          test
